extends: [cmake_package]
dependencies:
  build: [mpi, blas, lapack]

sources:
- url: http://trilinos.sandia.gov/download/files/trilinos-11.4.1-Source.tar.gz
  key: tar.gz:f75irrdmjj5sfvczu72gibqy7ktow2jp

build_stages:
- name: set-cc-compiler
  before: configure
  handler: bash
  bash: |
    export CC=${MPICC}
    export CXX=${MPICXX}

- name: configure
  mode: override
  extra: ['-D CMAKE_CXX_COMPILER:PATH=${MPICXX}',
          '-D CMAKE_C_COMPILER:PATH=${MPICC}',
          '-D CMAKE_Fortran_COMPILER:PATH=${MPIF90}',
          '-D CMAKE_BUILD_TYPE:STRING=RELEASE',
          '-D CMAKE_CXX_FLAGS=-g -O3',
          '-D CMAKE_C_FLAGS=-g -O3',
          '-D CMAKE_FORTRAN_FLAGS=-g -O5',
          '-D CMAKE_VERBOSE_MAKEFILE=FALSE',
          '-D Trilinos_EXTRA_LINK_FLAGS=${BLAS_LDFLAGS, LAPACK_LDFLAGS}',
          '-D Trilinos_VERBOSE_CONFIGURE=FALSE', 
          '-D Trilinos_ENABLE_TESTS:BOOL=ON',
          '-D Trilinos_ENABLE_ALL_OPTIONAL_PACKAGES:BOOL=OFF',
          '-D Trilinos_ENABLE_Sacado:BOOL=ON',
          '-D Trilinos_ENABLE_Stratimikos:BOOL=ON',
          '-D Trilinos_ENABLE_EpetraExt:BOOL=ON',
          '-D Trilinos_ENABLE_Amesos:BOOL=ON',
          '-D Trilinos_ENABLE_Ifpack:BOOL=ON',
          '-D Trilinos_ENABLE_AztecOO:BOOL=ON',
          '-D Trilinos_ENABLE_ML:BOOL=ON',
          '-D BUILD_SHARED_LIBS:BOOL=ON',
          '-D TPL_ENABLE_MPI:BOOL=ON',
#          '-D BLAS_LIBRARY_NAMES:STRING=openblas',
#          '-D BLAS_LIBRARY_DIRS:PATH=${OPENBLAS_DIR}/lib',
#          '-D LAPACK_LIBRARY_NAMES:STRING=lapack',
#          '-D LAPACK_LIBRARY_DIRS:PATH=${LAPACK_DIR}/lib',
          '-D BUILD_SHARED_LIBS:BOOL=ON',
          '-D CMAKE_INSTALL_PREFIX:PATH=${ARTIFACT}']

when_build_dependency:
- prepend_path: LD_LIBRARY_PATH
  value: ${ARTIFACT}/lib
